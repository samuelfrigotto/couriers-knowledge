<div class="matches-container">
  <div *ngIf="selectedMatch; else matchList" class="details-view">
    <!-- Header modernizado -->
    <div class="details-header">
      <button class="back-button" (click)="backToMatches()">
        {{ 'matches.header.backButton' | translate }}
      </button>
      <div class="details-title">
        <h2>
          {{ selectedMatch.radiant_win ? ('matches.teams.radiant' | translate) + ' ' + ('matches.result.victory' | translate) : ('matches.teams.dire' | translate) + ' ' + ('matches.result.victory' | translate) }}
        </h2>
        <span class="match-duration">{{ (selectedMatch.duration / 60) | number:'1.0-0' }}{{ 'matches.result.minutes' | translate }}</span>
      </div>
      <div class="details-score">
        <span class="radiant-score">{{ selectedMatch.radiant_score }}</span>
        <span class="vs-text">{{ 'matches.result.vs' | translate }}</span>
        <span class="dire-score">{{ selectedMatch.dire_score }}</span>
      </div>
    </div>

    <div *ngIf="isDetailsLoading" class="loading-message">{{ 'matches.loading.details' | translate }}</div>

    <div *ngIf="!isDetailsLoading" class="teams-container">
      <!-- Time Iluminado (Radiant) -->
      <div class="team-column">
        <div class="team-header">
          <h3 class="team-title">{{ 'matches.teams.radiantFull' | translate }}</h3>
        </div>

        <div *ngFor="let player of selectedMatch.players | filter:true:'is_radiant'" class="player-detail-card">
          <img [src]="gameDataService.getHeroImageUrl(player.hero_id)"
               appImageFallback
               [heroId]="player.hero_id"
               class="hero-portrait-detail"
               [alt]="gameDataService.getHeroById(player.hero_id)?.localized_name">

          <div class="player-info-detail">
            <span class="player-name-detail">{{ player.personaname || ('matches.player.anonymous' | translate) }}</span>
            <div class="kda">
              <span>{{ player.kills }}</span> /
              <span>{{ player.deaths }}</span> /
              <span>{{ player.assists }}</span>
            </div>
            <div class="player-gold">
              <span class="gold-value">{{ player.net_worth | number }}</span>
              <span class="gold-label">{{ 'matches.player.gold' | translate }}</span>
            </div>
          </div>

          <!-- Container dos itens -->
          <div class="items-container">
            <!-- InventÃ¡rio principal (6 itens em linha) -->
            <div class="items-grid">
              <img *ngFor="let itemId of player.items"
                   [src]="gameDataService.getItemImageUrl(itemId)"
                   appImageFallback
                   [itemId]="itemId"
                   class="item-icon"
                   [class.empty-slot]="itemId === 0"
                   [alt]="gameDataService.getItemById(itemId)?.localized_name">
            </div>

            <!-- Mochila (3 itens em preto e branco) -->
            <div class="backpack-grid">
              <img *ngFor="let itemId of player.backpack"
                   [src]="gameDataService.getItemImageUrl(itemId)"
                   appImageFallback
                   [itemId]="itemId"
                   class="item-icon"
                   [class.empty-slot]="itemId === 0"
                   [alt]="gameDataService.getItemById(itemId)?.localized_name">
            </div>
          </div>

          <button class="evaluate-button"
                  [disabled]="player.is_already_evaluated || !player.steam_id_64"
                  (click)="evaluatePlayer(player)">
            {{ player.is_already_evaluated ? ('matches.evaluation.evaluated' | translate) : ('matches.evaluation.evaluate' | translate) }}
          </button>
        </div>
      </div>

      <!-- Time Temido (Dire) - âœ… CORRIGIDO -->
      <div class="team-column">
        <div class="team-header">
          <h3 class="team-title">{{ 'matches.teams.direFull' | translate }}</h3>
        </div>

        <div *ngFor="let player of selectedMatch.players | filter:false:'is_radiant'" class="player-detail-card">
          <!-- âœ… CORREÃ‡ÃƒO: Imagem do herÃ³i (estava faltando!) -->
          <img [src]="gameDataService.getHeroImageUrl(player.hero_id)"
               appImageFallback
               [heroId]="player.hero_id"
               class="hero-portrait-detail"
               [alt]="gameDataService.getHeroById(player.hero_id)?.localized_name">

          <div class="player-info-detail">
            <span class="player-name-detail">{{ player.personaname || ('matches.player.anonymous' | translate) }}</span>
            <div class="kda">
              <span>{{ player.kills }}</span> /
              <span>{{ player.deaths }}</span> /
              <span>{{ player.assists }}</span>
            </div>
            <div class="player-gold">
              <span class="gold-value">{{ player.net_worth | number }}</span>
              <span class="gold-label">{{ 'matches.player.gold' | translate }}</span>
            </div>
          </div>

          <!-- Container dos itens -->
          <div class="items-container">
            <!-- InventÃ¡rio principal (6 itens em linha) -->
            <div class="items-grid">
              <img *ngFor="let itemId of player.items"
                   [src]="gameDataService.getItemImageUrl(itemId)"
                   appImageFallback
                   [itemId]="itemId"
                   class="item-icon"
                   [class.empty-slot]="itemId === 0"
                   [alt]="gameDataService.getItemById(itemId)?.localized_name">
            </div>

            <!-- Mochila (3 itens em preto e branco) -->
            <div class="backpack-grid">
              <img *ngFor="let itemId of player.backpack"
                   [src]="gameDataService.getItemImageUrl(itemId)"
                   appImageFallback
                   [itemId]="itemId"
                   class="item-icon"
                   [class.empty-slot]="itemId === 0"
                   [alt]="gameDataService.getItemById(itemId)?.localized_name">
            </div>
          </div>

          <button class="evaluate-button"
                  [disabled]="player.is_already_evaluated || !player.steam_id_64"
                  (click)="evaluatePlayer(player)">
            {{ player.is_already_evaluated ? ('matches.evaluation.evaluated' | translate) : ('matches.evaluation.evaluate' | translate) }}
          </button>
        </div>
      </div>
    </div>

    <div class="advanced-analysis-card" (click)="openStratzAnalysis(selectedMatch.match_id)">
      <div class="analysis-content">
        <div class="analysis-icon">
          ðŸ“Š
        </div>
        <div class="analysis-text">
          <h4>{{ 'matches.details.advancedAnalysis' | translate }}</h4>
          <p>{{ 'matches.details.stratzDescription' | translate }}</p>
        </div>
        <div class="analysis-arrow">
          â†’
        </div>
      </div>
      <div class="analysis-footer">
        <span class="powered-by">{{ 'matches.details.poweredBy' | translate }}</span>
        <span class="match-id">{{ 'matches.details.matchId' | translate:{ matchId: selectedMatch.match_id } }}</span>
      </div>
    </div>

  </div>

  <!-- Lista de partidas -->
  <ng-template #matchList>
    <h1>{{ 'matches.title' | translate }}</h1>
    <!-- Estado de carregamento -->
    <div *ngIf="isLoading$ | async">
      <app-empty-state
        [config]="{
          type: 'matches',
          title: ('matches.loading.title' | translate),
          subtitle: ('matches.loading.subtitle' | translate),
          showAction: false
        }">
      </app-empty-state>
    </div>

    <!-- Estado vazio quando nÃ£o hÃ¡ partidas -->
    <div *ngIf="(matches$ | async)?.length === 0 && !(isLoading$ | async)">
      <app-empty-state
        [config]="{
          type: 'matches',
          title: ('matches.empty.title' | translate),
          subtitle: ('matches.empty.subtitle' | translate),
          actionText: ('matches.empty.action' | translate),
          showAction: false
        }"
        (emptyStateAction)="onEmptyStateAction($event)">
      </app-empty-state>
    </div>

    <div class="match-list-container" *ngIf="matches$ | async as matches">
      <div *ngIf="matches.length > 0" class="match-row-header">
        <div class="header-player">{{ 'matches.table.yourHero' | translate }}</div>
        <div class="header-result">{{ 'matches.table.result' | translate }}</div>
        <div class="header-heroes">{{ 'matches.table.heroes' | translate }}</div>
        <div class="header-info">{{ 'matches.table.duration' | translate }}</div>
      </div>
      <div *ngFor="let match of matches"
           class="match-row"
           [ngClass]="{ 'win': match.user_won, 'loss': !match.user_won }"
           (click)="viewMatchDetails(match.match_id)">
        <div class="match-player-col">
          <img [src]="gameDataService.getHeroImageUrl(match.user_hero_id)"
               appImageFallback
               [heroId]="match.user_hero_id"
               class="hero-icon-medium"
               [alt]="gameDataService.getHeroById(match.user_hero_id)?.localized_name">
          <span class="hero-name">{{ gameDataService.getHeroById(match.user_hero_id)?.localized_name }}</span>
        </div>
        <div class="match-result-col">
          <span class="result-text">{{ match.user_won ? ('matches.result.victory' | translate) : ('matches.result.defeat' | translate) }}</span>
        </div>
        <div class="match-heroes-col">
          <div class="team-heroes radiant">
            <img *ngFor="let player of match.players | filter:true:'is_radiant'"
                 [src]="gameDataService.getHeroImageUrl(player.hero_id)"
                 appImageFallback
                 [heroId]="player.hero_id"
                 class="hero-icon-small"
                 [class.user-hero]="player.hero_id === match.user_hero_id"
                 [alt]="gameDataService.getHeroById(player.hero_id)?.localized_name">
          </div>
          <div class="score-vs">
            <span class="radiant-score">{{ match.radiant_score }}</span>
            <span class="vs-text">{{ 'matches.result.vs' | translate }}</span>
            <span class="dire-score">{{ match.dire_score }}</span>
          </div>
          <div class="team-heroes dire">
            <!-- âœ… CORREÃ‡ÃƒO: Adicionado [heroId]="player.hero_id" que estava faltando -->
            <img *ngFor="let player of match.players | filter:false:'is_radiant'"
                 [src]="gameDataService.getHeroImageUrl(player.hero_id)"
                 appImageFallback
                 [heroId]="player.hero_id"
                 class="hero-icon-small"
                 [class.user-hero]="player.hero_id === match.user_hero_id"
                 [alt]="gameDataService.getHeroById(player.hero_id)?.localized_name">
          </div>
        </div>
        <div class="match-info-col">
          <span>{{ (match.duration / 60) | number:'1.0-0' }}{{ 'matches.result.minutes' | translate }}</span>
          <small>{{ match.start_time * 1000 | date:'dd/MM/yy HH:mm' }}</small>
        </div>
      </div>
    </div>
  </ng-template>
</div>

<app-evaluation-form
  *ngIf="isFormVisible"
  [evaluationData]="evaluationInitialData"
  (formClosed)="closeForm()"
  (formSubmitted)="onEvaluationSaved()"
  (evaluationError)="onEvaluationError($event)">
</app-evaluation-form>
