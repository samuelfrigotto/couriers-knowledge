<!-- DASHBOARD.COMPONENT.HTML COMPLETO COM IMPORT/EXPORT -->

<div class="dashboard-container">
  <!-- Header principal -->
  <div class="dashboard-header">
    <div class="header-left">
      <h1>Minhas Avalia√ß√µes</h1>

      <!-- Filtro de jogador sempre vis√≠vel -->
      <div class="permanent-search-filter">
        <div class="search-input-wrapper">
          <i class="search-icon">‚åï</i>
          <input
            type="text"
            placeholder="Buscar jogador..."
            [formControl]="permanentSearchControl"
            class="permanent-search-input"
            #searchInput
          />
          <button
            *ngIf="permanentSearchControl.value"
            class="clear-search-btn"
            (click)="clearPermanentSearch()"
            title="Limpar busca"
          >
            √ó
          </button>
        </div>

        <!-- Resultados da busca -->
        <div
          *ngIf="permanentSearchControl.value && filteredBySearch && filteredBySearch.length > 0"
          class="search-results-count"
        >
          {{ filteredBySearch.length }} resultado(s) encontrado(s)
        </div>
        <div
          *ngIf="permanentSearchControl.value && filteredBySearch && filteredBySearch.length === 0"
          class="search-no-results"
        >
          Nenhum jogador encontrado
        </div>
      </div>
    </div>

    <div class="header-actions">
      <!-- Bot√µes de Import/Export -->
      <div class="import-export-actions">
        <button
          class="export-btn"
          (click)="openExportModal()"
          title="Exportar avalia√ß√µes"
        >
          <i class="icon">üì§</i>
          Exportar
        </button>

        <button
          class="import-btn"
          (click)="openImportModal()"
          title="Importar avalia√ß√µes"
        >
          <i class="icon">üì•</i>
          Importar
        </button>
      </div>

      <!-- Modo de sele√ß√£o -->
      <button
        class="selection-toggle-btn"
        [class.active]="isSelectionMode"
        (click)="toggleSelectionMode()"
        title="Ativar/desativar modo de sele√ß√£o"
      >
        <i class="icon">‚òëÔ∏è</i>
        {{ isSelectionMode ? 'Sair da Sele√ß√£o' : 'Selecionar' }}
      </button>

      <!-- Controles de sele√ß√£o m√∫ltipla -->
      <div *ngIf="isSelectionMode" class="selection-controls">
        <span class="selection-count">
          {{ getSelectedCount() }}/{{ getTotalDisplayed() }} selecionados
        </span>
        <button
          class="select-all-btn"
          (click)="selectAllEvaluations()"
          [disabled]="getSelectedCount() === getTotalDisplayed()"
        >
          Todos
        </button>
        <button
          class="clear-selection-btn"
          (click)="clearAllSelections()"
          [disabled]="getSelectedCount() === 0"
        >
          Limpar
        </button>
      </div>

      <!-- Bot√£o de atualizar nomes -->
      <button
        class="refresh-button"
        (click)="refreshNames()"
        [disabled]="isRefreshing"
      >
        {{ isRefreshing ? "Atualizando..." : "Atualizar Nomes" }}
      </button>

      <!-- Bot√£o de nova avalia√ß√£o -->
      <div class="new-evaluation-button-wrapper">
        <button
          class="new-evaluation-btn"
          [class.disabled]="isLimitReached"
          [disabled]="isLimitReached"
          (click)="openFormModal()"
          [title]="
            isLimitReached
              ? 'Limite de avalia√ß√µes atingido. Fa√ßa upgrade para Premium!'
              : 'Criar nova avalia√ß√£o'
          "
        >
          + Nova Avalia√ß√£o
        </button>

        <!-- Indicador de limite -->
        <div *ngIf="evaluationStatus" class="evaluation-counter">
          <span [class.warning]="isLimitReached">
            {{ evaluationStatus.currentCount }}{{ evaluationStatus.limit ? '/' + evaluationStatus.limit : '' }}
          </span>
          <span *ngIf="!evaluationStatus.isPremium" class="plan-label">
            ({{ evaluationStatus.isPremium ? 'Premium' : 'Gratuito' }})
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de avalia√ß√µes -->
  <div class="evaluations-content">
    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Carregando suas avalia√ß√µes...</p>
    </div>

    <!-- Lista vazia -->
    <app-empty-state
      *ngIf="!isLoading && displayedEvaluations.length === 0"
      [config]="{
        type: 'evaluations',
        title: 'Nenhuma avalia√ß√£o encontrada',
        subtitle: 'Comece avaliando seus companheiros de equipe para acompanhar o desempenho deles!',
        actionText: isLimitReached ? '' : 'Criar Primeira Avalia√ß√£o',
        showAction: !isLimitReached
      }"
      (actionClick)="openFormModal()">
    </app-empty-state>

    <!-- Lista com dados -->
    <div *ngIf="!isLoading && displayedEvaluations.length > 0" class="evaluations-list">
      <!-- Cabe√ßalho da lista -->
      <div class="list-header">
        <div class="header-col col-selection" *ngIf="isSelectionMode">
          <!-- Empty for checkbox column -->
        </div>
        <div class="header-col col-player">
          <div class="header-title">
            Jogador
          </div>
        </div>
        <div class="header-col col-hero">
          <div class="header-title">
            Her√≥i & Fun√ß√£o
          </div>
        </div>
        <div class="header-col col-rating">
          <div class="header-title">
            Avalia√ß√£o
          </div>
        </div>
        <div class="header-col col-notes">
          <div class="header-title">
            Anota√ß√µes
          </div>
        </div>
        <div class="header-col col-tags">
          <div class="header-title">
            Tags
          </div>
        </div>
        <div class="header-col col-actions">
          <!-- Actions column -->
        </div>
      </div>

      <!-- Items da lista -->
      <div
        *ngFor="let evaluation of displayedEvaluations; trackBy: trackByEvaluationId"
        class="list-item"
        [class.selected]="isEvaluationSelected(evaluation.id)"
      >
        <!-- Checkbox de sele√ß√£o -->
        <div *ngIf="isSelectionMode" class="col-selection">
          <input
            type="checkbox"
            [checked]="isEvaluationSelected(evaluation.id)"
            (change)="toggleEvaluationSelection(evaluation.id)"
            class="evaluation-checkbox"
          >
        </div>

        <!-- Coluna do jogador -->
        <div class="col-player" data-label="Jogador:">
          <div class="player-info-wrapper">
            <strong class="player-name">{{ evaluation.targetPlayerName || 'Jogador Desconhecido' }}</strong>
            <small *ngIf="evaluation.target_player_steam_id" class="steam-id">
              ID: {{ evaluation.target_player_steam_id }}
            </small>
            <small *ngIf="evaluation.match_id" class="match-id">
              Partida: {{ evaluation.match_id }}
            </small>
          </div>
        </div>

        <!-- Coluna do her√≥i -->
        <div class="col-hero" data-label="Her√≥i:">
          <div class="hero-info">
            <ng-container *ngIf="evaluation.hero_id; else noHero">
              <img
                [src]="gameDataService.getHeroImageUrl(evaluation.hero_id)"
                [alt]="gameDataService.getHeroById(evaluation.hero_id)?.localized_name"
                class="hero-image"
                loading="lazy"
              >
              <span class="hero-name">
                {{ gameDataService.getHeroById(evaluation.hero_id)?.localized_name }}
              </span>
            </ng-container>
            <ng-template #noHero>
              <span class="no-info">Her√≥i n√£o informado</span>
            </ng-template>
          </div>

          <div *ngIf="evaluation.role" class="role-badge">
            {{ evaluation.role }}
          </div>
        </div>

        <!-- Coluna da avalia√ß√£o -->
        <div class="col-rating" data-label="Nota:">
          <app-rating-display [rating]="evaluation.rating" />
        </div>

        <!-- Coluna das anota√ß√µes -->
        <div class="col-notes" data-label="Anota√ß√µes:">
          <p *ngIf="evaluation.notes; else noNotes">
            {{ evaluation.notes }}
          </p>
          <ng-template #noNotes>
            <span class="no-info">Sem anota√ß√µes</span>
          </ng-template>
        </div>

        <!-- Coluna das tags -->
        <div class="col-tags" data-label="Tags:">
          <div class="tags-wrapper">
            <ng-container *ngIf="evaluation.tags && evaluation.tags.length > 0; else noTags">
              <span
                *ngFor="let tag of evaluation.tags"
                class="tag-badge"
              >
                {{ tag }}
              </span>
            </ng-container>
            <ng-template #noTags>
              <span class="no-info">Sem tags</span>
            </ng-template>
          </div>
        </div>

        <!-- Coluna das a√ß√µes -->
        <div class="col-actions">
          <div class="action-menu-container">
            <button
              class="action-menu-btn"
              (click)="toggleActionMenu($event, evaluation.id)"
              [class.active]="activeActionMenu === evaluation.id"
            >
              ‚ãÆ
            </button>

            <div
              *ngIf="activeActionMenu === evaluation.id"
              class="action-popover"
            >
              <button (click)="openFormModal(evaluation)" class="action-item edit">
                ‚úèÔ∏è Editar
              </button>
              <button (click)="shareEvaluation(evaluation)" class="action-item share">
                üìã Copiar
              </button>
              <button (click)="deleteEvaluation(evaluation.id)" class="action-item delete">
                üóëÔ∏è Excluir
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL DE EXPORTA√á√ÉO ===== -->
<div *ngIf="showExportModal" class="modal-overlay" (click)="closeExportModal()">
  <div class="modal export-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Exportar Avalia√ß√µes</h3>
      <button class="modal-close-btn" (click)="closeExportModal()">√ó</button>
    </div>

    <div class="modal-content">
      <div class="export-options">
        <label class="radio-option">
          <input
            type="radio"
            name="exportType"
            value="all"
            [(ngModel)]="exportType"
            [disabled]="isExporting"
          >
          <span class="radio-label">
            <strong>Todas as avalia√ß√µes</strong>
            <small>({{ getTotalDisplayed() }} avalia√ß√µes)</small>
          </span>
        </label>

        <label
          class="radio-option"
          [class.disabled]="getSelectedCount() === 0"
        >
          <input
            type="radio"
            name="exportType"
            value="selected"
            [(ngModel)]="exportType"
            [disabled]="isExporting || getSelectedCount() === 0"
          >
          <span class="radio-label">
            <strong>Avalia√ß√µes selecionadas</strong>
            <small>({{ getSelectedCount() }} avalia√ß√µes)</small>
          </span>
        </label>
      </div>

      <div class="export-info">
        <div class="info-box">
          <h4>üìã O que ser√° exportado:</h4>
          <ul>
            <li>Dados completos das avalia√ß√µes</li>
            <li>Informa√ß√µes dos jogadores</li>
            <li>Tags e anota√ß√µes</li>
            <li>C√≥digo de compartilhamento</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button
        (click)="exportEvaluations()"
        class="btn-primary"
        [disabled]="isExporting || (exportType === 'selected' && getSelectedCount() === 0)"
      >
        <span *ngIf="!isExporting">Exportar</span>
        <span *ngIf="isExporting">
          <span class="spinner"></span>
          Exportando...
        </span>
      </button>
      <button
        (click)="closeExportModal()"
        class="btn-secondary"
        [disabled]="isExporting"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL DE IMPORTA√á√ÉO ===== -->
<div *ngIf="showImportModal" class="modal-overlay" (click)="closeImportModal()">
  <div class="modal import-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Importar Avalia√ß√µes</h3>
      <button class="modal-close-btn" (click)="closeImportModal()">√ó</button>
    </div>

    <div class="modal-content">
      <!-- Tabs de importa√ß√£o -->
      <div class="import-tabs">
        <button
          class="tab-btn"
          [class.active]="importTab === 'file'"
          (click)="importTab = 'file'"
          [disabled]="isImporting"
        >
          üìÅ Arquivo JSON
        </button>
        <button
          class="tab-btn"
          [class.active]="importTab === 'code'"
          (click)="importTab = 'code'"
          [disabled]="isImporting"
        >
          üîó C√≥digo
        </button>
      </div>

      <!-- Conte√∫do das tabs -->
      <div class="import-content">
        <!-- Tab de arquivo -->
        <div *ngIf="importTab === 'file'" class="file-import-section">
          <input
            type="file"
            accept=".json"
            (change)="onFileSelected($event)"
            #fileInput
            class="file-input"
            [disabled]="isImporting"
          >

          <div
            class="file-drop-zone"
            [class.drag-over]="isDragOver"
            [class.has-file]="selectedFile"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onFileDropped($event)"
            (click)="fileInput.click()"
          >
            <div *ngIf="!selectedFile" class="drop-zone-empty">
              <i class="drop-icon">‚òÅÔ∏è</i>
              <p class="drop-text">
                <strong>Arraste um arquivo JSON aqui</strong><br>
                ou clique para selecionar
              </p>
              <small>M√°ximo: 10MB</small>
            </div>

            <div *ngIf="selectedFile" class="drop-zone-file">
              <i class="file-icon">üìÑ</i>
              <div class="file-info">
                <strong>{{ selectedFile.name }}</strong>
                <small>{{ (selectedFile.size / 1024).toFixed(1) }} KB</small>
              </div>
              <button
                class="remove-file-btn"
                (click)="$event.stopPropagation(); selectedFile = null; importPreview = null"
                [disabled]="isImporting"
              >
                √ó
              </button>
            </div>
          </div>

          <!-- Preview do arquivo -->
          <div *ngIf="importPreview" class="import-preview">
            <h4>üìä Pr√©via da Importa√ß√£o:</h4>
            <div class="preview-info">
              <div class="preview-item">
                <strong>Total de avalia√ß√µes:</strong> {{ importPreview.total }}
              </div>
              <div class="preview-item">
                <strong>Exportado por:</strong> {{ importPreview.exportedBy }}
              </div>
              <div class="preview-item" *ngIf="importPreview.exportedAt">
                <strong>Data da exporta√ß√£o:</strong>
                {{ importPreview.exportedAt | date:'dd/MM/yyyy HH:mm' }}
              </div>
              <div class="preview-item">
                <strong>Vers√£o:</strong> {{ importPreview.version }}
              </div>
            </div>
          </div>
        </div>

        <!-- Tab de c√≥digo -->
        <div *ngIf="importTab === 'code'" class="code-import-section">
          <div class="code-input-wrapper">
            <input
              type="text"
              placeholder="Digite o c√≥digo de compartilhamento (ex: ABC12DE4)"
              [(ngModel)]="shareCode"
              class="share-code-input"
              [disabled]="isImporting"
              maxlength="16"
            >
          </div>

          <div class="code-help">
            <p class="help-text">
              <i>üí°</i>
              O c√≥digo de compartilhamento tem 8 caracteres e √© fornecido quando algu√©m exporta avalia√ß√µes.
            </p>
          </div>
        </div>
      </div>

      <!-- Modo de importa√ß√£o -->
      <div class="import-mode-section">
        <label class="mode-label">‚öôÔ∏è Modo de importa√ß√£o:</label>
        <select
          [(ngModel)]="importMode"
          class="mode-select"
          [disabled]="isImporting"
        >
          <option value="add">Adicionar (manter existentes)</option>
          <option value="merge">Mesclar (atualizar existentes)</option>
          <option value="replace">Substituir (limpar tudo antes)</option>
        </select>

        <small class="mode-description">
          {{ getImportModeDescription() }}
        </small>
      </div>
    </div>

    <div class="modal-actions">
      <button
        (click)="importEvaluations()"
        class="btn-primary"
        [disabled]="!canImport() || isImporting"
      >
        <span *ngIf="!isImporting">üì• Importar</span>
        <span *ngIf="isImporting">
          <span class="spinner"></span>
          Importando...
        </span>
      </button>
      <button
        (click)="closeImportModal()"
        class="btn-secondary"
        [disabled]="isImporting"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal do formul√°rio de avalia√ß√£o -->
<app-evaluation-form
  *ngIf="isFormModalVisible"
  [evaluationData]="selectedEvaluation"
  (formSubmitted)="onFormSubmitted()"
  (formClosed)="onFormClosed()"
  (evaluationError)="onEvaluationError($event)"
></app-evaluation-form>
