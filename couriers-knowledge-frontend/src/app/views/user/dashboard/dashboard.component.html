<!-- DASHBOARD.COMPONENT.HTML COMPLETO COM IMPORT/EXPORT -->

<div class="dashboard-container">
  <!-- Header principal -->

   <div class="dashboard-header">
    <!-- Primeira linha -->
    <div class="header-row-1">
      <h1>Minhas Avaliações</h1>

      <div class="row1-actions">
        <div class="import-export-aligned">
          <button
            class="import-btn"
            [class.limit-reached]="isImportLimitReached()"
            [disabled]="isImportLimitReached()"
            (click)="openImportModal()"
            title="Importar avaliações"
          >
            Importar
            <span *ngIf="isImportLimitReached()" class="limit-badge">Limite</span>
          </button>
        </div>

        <button
          class="selection-toggle-btn"
          [class.active]="isSelectionMode"
          (click)="toggleSelectionMode()"
          title="Ativar/desativar modo de seleção"
        >
          {{ isSelectionMode ? 'Sair da Seleção' : 'Selecionar' }}
        </button>

        <button
          class="new-evaluation-btn"
          [class.disabled]="isLimitReached"
          [disabled]="isLimitReached"
          (click)="openFormModal()"
          [title]="
            isLimitReached
              ? 'Limite de avaliações atingido. Faça upgrade para Premium!'
              : 'Criar nova avaliação'
          "
        >
          Nova Avaliação
        </button>
      </div>
    </div>

    <!-- Segunda linha -->
    <div class="header-row-2">
      <!-- Filtro de busca -->
      <div class="search-section">
        <div class="search-input-wrapper">
          <i class="search-icon">⌕</i>
          <input
            type="text"
            placeholder="Buscar Jogador"
            [formControl]="permanentSearchControl"
            class="permanent-search-input"
            #searchInput
          />
          <button
            *ngIf="permanentSearchControl.value"
            class="clear-search-btn"
            (click)="clearPermanentSearch()"
            title="Limpar busca"
          >
            ×
          </button>
        </div>

        <!-- Resultados da busca -->
        <div
          *ngIf="permanentSearchControl.value && filteredBySearch && filteredBySearch.length > 0"
          class="search-results-count"
        >
          {{ filteredBySearch.length }} resultado(s)
        </div>
        <div
          *ngIf="permanentSearchControl.value && filteredBySearch && filteredBySearch.length === 0"
          class="search-no-results"
        >
          Nenhum jogador encontrado
        </div>
      </div>

      <div class="row2-actions">
        <div class="import-export-aligned">
          <button
            class="export-btn"
            [class.limit-reached]="isExportLimitReached()"
            [disabled]="isExportLimitReached()"
            (click)="openExportModal()"
            title="Exportar avaliações"
          >
            Exportar
            <span *ngIf="isExportLimitReached()" class="limit-badge">Limite</span>
          </button>
        </div>

        <button
          class="refresh-button"
          (click)="refreshNames()"
          [disabled]="isRefreshing"
          title="Atualizar nomes dos jogadores"
        >
          {{ isRefreshing ? "Atualizando..." : "Atualizar Nomes" }}
        </button>

        <!-- Status das avaliações -->
        <div class="evaluation-status-compact">
          <div *ngIf="evaluationStatus" class="status-display">
            <span class="count-text" [class.warning]="isLimitReached">
              {{ evaluationStatus.currentCount }}{{ evaluationStatus.limit ? '/' + evaluationStatus.limit : '' }}
            </span>
            <span class="plan-badge" [class.premium]="evaluationStatus.isPremium">
              {{ evaluationStatus.isPremium ? 'Premium' : 'Free' }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Controles de seleção (quando ativo) -->
    <div *ngIf="isSelectionMode" class="selection-controls-row">
      <div class="selection-controls">
        <span class="selection-count">
          {{ getSelectedCount() }}/{{ getTotalDisplayed() }} selecionados
        </span>
        <button
          class="select-all-btn"
          (click)="selectAllEvaluations()"
          [disabled]="getSelectedCount() === getTotalDisplayed()"
        >
          Selecionar Todos
        </button>
        <button
          class="clear-selection-btn"
          (click)="clearAllSelections()"
          [disabled]="getSelectedCount() === 0"
        >
          Limpar Seleção
        </button>
      </div>
    </div>
  </div>


  <!-- Lista de avaliações -->
  <div class="evaluations-content">
    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Carregando suas avaliações...</p>
    </div>

    <!-- Lista vazia -->
    <app-empty-state
      *ngIf="!isLoading && displayedEvaluations.length === 0"
      [config]="{
        type: 'evaluations',
        title: 'Nenhuma avaliação encontrada',
        subtitle:
          'Comece avaliando seus companheiros de equipe para acompanhar o desempenho deles!',
        actionText: isLimitReached ? '' : 'Criar Primeira Avaliação',
        showAction: !isLimitReached
      }"
      (actionClick)="openFormModal()"
    >
    </app-empty-state>

    <!-- Lista com dados -->
    <div
      *ngIf="!isLoading && displayedEvaluations.length > 0"
      class="evaluations-list"
    >
      <!-- Cabeçalho da lista -->
      <div class="list-header">
        <div class="header-col col-selection" *ngIf="isSelectionMode">
          <!-- Empty for checkbox column -->
        </div>
        <div class="header-col col-player">
          <div class="header-title">Jogador</div>
        </div>
        <div class="header-col col-hero">
          <div class="header-title">Herói & Função</div>
        </div>
        <div class="header-col col-rating">
          <div class="header-title">Avaliação</div>
        </div>
        <div class="header-col col-notes">
          <div class="header-title">Anotações</div>
        </div>
        <div class="header-col col-tags">
          <div class="header-title">Tags</div>
        </div>
        <div class="header-col col-actions">
          <!-- Actions column -->
        </div>
      </div>

      <!-- Items da lista -->
      <div
        *ngFor="
          let evaluation of displayedEvaluations;
          trackBy: trackByEvaluationId
        "
        class="list-item"
        [class.selected]="isEvaluationSelected(evaluation.id)"
      >
        <!-- Checkbox de seleção -->
        <div *ngIf="isSelectionMode" class="col-selection">
          <input
            type="checkbox"
            [checked]="isEvaluationSelected(evaluation.id)"
            (change)="toggleEvaluationSelection(evaluation.id)"
            class="evaluation-checkbox"
          />
        </div>

        <!-- Coluna do jogador -->
        <div class="col-player" data-label="Jogador:">
          <div class="player-info-wrapper">
            <strong class="player-name">{{
              evaluation.targetPlayerName || "Jogador Desconhecido"
            }}</strong>
            <small *ngIf="evaluation.target_player_steam_id" class="steam-id">
              ID: {{ evaluation.target_player_steam_id }}
            </small>
            <small *ngIf="evaluation.match_id" class="match-id">
              Partida: {{ evaluation.match_id }}
            </small>
          </div>
        </div>

        <!-- Coluna do herói -->
        <div class="col-hero" data-label="Herói:">
          <div class="hero-info">
            <ng-container *ngIf="evaluation.hero_id; else noHero">
              <img
                [src]="gameDataService.getHeroImageUrl(evaluation.hero_id)"
                [alt]="
                  gameDataService.getHeroById(evaluation.hero_id)
                    ?.localized_name
                "
                class="hero-image"
                loading="lazy"
              />
              <span class="hero-name">
                {{
                  gameDataService.getHeroById(evaluation.hero_id)
                    ?.localized_name
                }}
              </span>
            </ng-container>
            <ng-template #noHero>
              <span class="no-info">Herói não informado</span>
            </ng-template>
          </div>

          <div *ngIf="evaluation.role" class="role-badge">
            {{ evaluation.role }}
          </div>
        </div>

        <!-- Coluna da avaliação -->
        <div class="col-rating" data-label="Nota:">
          <app-rating-display [rating]="evaluation.rating" />
        </div>

        <!-- Coluna das anotações -->
        <div class="col-notes" data-label="Anotações:">
          <p *ngIf="evaluation.notes; else noNotes">
            {{ evaluation.notes }}
          </p>
          <ng-template #noNotes>
            <span class="no-info">Sem anotações</span>
          </ng-template>
        </div>

        <!-- Coluna das tags -->
        <div class="col-tags" data-label="Tags:">
          <div class="tags-wrapper">
            <ng-container
              *ngIf="evaluation.tags && evaluation.tags.length > 0; else noTags"
            >
              <span *ngFor="let tag of evaluation.tags" class="tag-badge">
                {{ tag }}
              </span>
            </ng-container>
            <ng-template #noTags>
              <span class="no-info">Sem tags</span>
            </ng-template>
          </div>
        </div>

        <!-- Coluna das ações -->
        <div class="col-actions">
          <div class="action-menu-container">
            <button
              class="action-menu-btn"
              (click)="toggleActionMenu($event, evaluation.id)"
              [class.active]="activeActionMenu === evaluation.id"
            >
              ⋮
            </button>

            <div
              *ngIf="activeActionMenu === evaluation.id"
              class="action-popover"
            >
              <button
                (click)="openFormModal(evaluation)"
                class="action-item edit"
              >
                Editar
              </button>
              <button
                (click)="shareEvaluation(evaluation)"
                class="action-item share"
              >
                Compartilhar
              </button>
              <button
                (click)="deleteEvaluation(evaluation.id)"
                class="action-item delete"
              >
                Excluir
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL DE EXPORTAÇÃO ===== -->
<div *ngIf="showExportModal" class="modal-overlay" (click)="closeExportModal()">
  <div class="modal export-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        {{ exportResult ? "Exportação Concluída!" : "Exportar Avaliações" }}
      </h3>
      <button class="modal-close-btn" (click)="closeExportModal()">×</button>
    </div>

    <div class="modal-content">
      <!-- ANTES da exportação -->
      <div *ngIf="!exportResult && !isExporting">
        <div class="export-options">
          <label class="radio-option">
            <input
              type="radio"
              name="exportType"
              value="all"
              [(ngModel)]="exportType"
              [disabled]="isExporting"
            />
            <span class="radio-label">
              <strong>Todas as avaliações</strong>
              <small>({{ getTotalDisplayed() }} avaliações)</small>
            </span>
          </label>

          <label
            class="radio-option"
            [class.disabled]="getSelectedCount() === 0"
          >
            <input
              type="radio"
              name="exportType"
              value="selected"
              [(ngModel)]="exportType"
              [disabled]="isExporting || getSelectedCount() === 0"
            />
            <span class="radio-label">
              <strong>Avaliações selecionadas</strong>
              <small>({{ getSelectedCount() }} avaliações)</small>
            </span>
          </label>
        </div>

        <div class="export-info">
          <div class="info-box">
            <h4>📋 O que será exportado:</h4>
            <ul>
              <li>Arquivo JSON para backup local</li>
              <li>Código de compartilhamento (válido por 30 dias)</li>
              <li>Dados completos das avaliações</li>
              <li>Informações dos jogadores e tags</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- DURANTE a exportação -->
      <div *ngIf="isExporting" class="export-loading">
        <div class="loading-spinner"></div>
        <p>Processando exportação...</p>
        <small>Gerando arquivo e código de compartilhamento</small>
      </div>

      <!-- DEPOIS da exportação - MOSTRAR CÓDIGO -->
      <div *ngIf="exportResult && !isExporting" class="export-success">
        <div class="success-message">
          <h4>✅ Exportação realizada com sucesso!</h4>
          <p>{{ exportResult.totalEvaluations }} avaliações exportadas</p>
        </div>

        <!-- CÓDIGO DE COMPARTILHAMENTO -->
        <div class="share-code-section">
          <h4>🔗 Código de Compartilhamento:</h4>
          <div class="share-code-display">
            <div class="code-box">
              <span class="share-code-text">{{
                formatShareCode(exportResult.shareCode)
              }}</span>
              <button
                class="copy-code-btn"
                (click)="copyShareCode()"
                title="Copiar código"
              >
                📋
              </button>
            </div>
          </div>

          <div class="code-instructions">
            <p><strong>📱 Como compartilhar:</strong></p>
            <ul>
              <li>Copie o código acima</li>
              <li>Envie para outros jogadores via WhatsApp/Discord</li>
              <li>Eles podem usar esse código na opção "Importar → Código"</li>
            </ul>

            <div class="code-details">
              <small>
                <strong>⏰ Válido até:</strong>
                {{ exportResult.exportedAt | date : "dd/MM/yyyy" }} (30 dias)<br />
                <strong>📄 Arquivo JSON:</strong> Baixado automaticamente para
                backup
              </small>
            </div>
          </div>
        </div>

        <!-- EXEMPLO DE USO -->
        <div class="usage-example">
          <h5>💬 Exemplo de mensagem para compartilhar:</h5>
          <div class="example-message">
            "Pessoal, exportei minhas avaliações do Courier's Knowledge!<br />
            Usem o código:
            <strong>{{ formatShareCode(exportResult.shareCode) }}</strong
            ><br />
            Vão em Importar → Código e colem esse código."
          </div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <!-- Botões ANTES da exportação -->
      <ng-container *ngIf="!exportResult && !isExporting">
        <button
          (click)="exportEvaluations()"
          class="btn-primary"
          [disabled]="
            isExporting ||
            (exportType === 'selected' && getSelectedCount() === 0)
          "
        >
          <span *ngIf="!isExporting">Exportar</span>
          <span *ngIf="isExporting">
            <span class="spinner"></span>
            Exportando...
          </span>
        </button>
        <button
          (click)="closeExportModal()"
          class="btn-secondary"
          [disabled]="isExporting"
        >
          Cancelar
        </button>
      </ng-container>

      <!-- Botões DEPOIS da exportação -->
      <ng-container *ngIf="exportResult && !isExporting">
        <button (click)="copyShareCode()" class="btn-primary">
          📋 Copiar Código
        </button>
        <button (click)="closeExportModal()" class="btn-secondary">
          Fechar
        </button>
      </ng-container>
    </div>
  </div>
</div>

<!-- ===== MODAL DE IMPORTAÇÃO ===== -->
<div *ngIf="showImportModal" class="modal-overlay" (click)="closeImportModal()">
  <div class="modal import-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Importar Avaliações</h3>
      <button class="modal-close-btn" (click)="closeImportModal()">×</button>
    </div>

    <div class="modal-content">
      <!-- Tabs de importação -->
      <div class="import-tabs">
        <button
          class="tab-btn"
          [class.active]="importTab === 'paste'"
          (click)="importTab = 'paste'"
          [disabled]="isImporting"
        >
          <i>📋</i> Colar
        </button>

        <button
          class="tab-btn"
          [class.active]="importTab === 'file'"
          (click)="importTab = 'file'"
          [disabled]="isImporting"
        >
          <i>📁</i> Arquivo
        </button>

        <button
          class="tab-btn"
          [class.active]="importTab === 'code'"
          (click)="importTab = 'code'"
          [disabled]="isImporting"
        >
          <i>🔗</i> Código
        </button>
      </div>

      <!-- Conteúdo das tabs -->
      <div class="import-content">
        <!-- Tab de colar (NOVA) -->
        <div *ngIf="importTab === 'paste'" class="paste-import-section">
          <div class="paste-description">
            <p>
              <i>📋</i>
              <strong>Cole aqui uma avaliação compartilhada:</strong><br />
              <small
                >Aceita tanto texto amigável (WhatsApp/Discord) quanto dados
                JSON exportados!</small
              >
            </p>
          </div>

          <div class="paste-input-wrapper">
            <textarea
              placeholder='Cole aqui uma avaliação compartilhada...

Exemplo de texto amigável:
[Courier&apos;s Knowledge] Avaliação de jogador:
- Jogador: PlayerName
- Herói: Pudge
- Partida: 8383745353
- Nota: 4/5 (★★★★☆)
- Anotações: "Jogou bem de suporte"
- Tags: #bom-suporte #teamwork

Ou dados JSON exportados:
{
  "version": "1.0",
  "evaluations": [...]
}'
              [(ngModel)]="pastedText"
              (input)="onPastedTextChange()"
              class="paste-textarea"
              [disabled]="isImporting"
              rows="10"
            ></textarea>
          </div>

          <!-- Preview dos dados colados -->
          <div *ngIf="pastedPreview" class="import-preview">
            <h4>📊 Prévia da Importação:</h4>
            <div class="preview-info">
              <div class="preview-item">
                <strong>Total de avaliações:</strong> {{ pastedPreview.total }}
              </div>
              <div class="preview-item">
                <strong>Tipo:</strong>
                <span *ngIf="pastedPreview.type === 'text'"
                  >Texto Amigável</span
                >
                <span *ngIf="pastedPreview.type === 'json'">Dados JSON</span>
              </div>
              <div class="preview-item">
                <strong>Fonte:</strong> {{ pastedPreview.exportedBy }}
              </div>
              <div class="preview-item" *ngIf="pastedPreview.exportedAt">
                <strong>Data:</strong>
                {{ pastedPreview.exportedAt | date : "dd/MM/yyyy HH:mm" }}
              </div>
              <div
                class="preview-item"
                *ngIf="
                  pastedPreview.type === 'text' && pastedPreview.evaluation
                "
              >
                <strong>Jogador:</strong>
                {{ pastedPreview.evaluation.target_player_name || "N/A" }}
              </div>
              <div
                class="preview-item"
                *ngIf="
                  pastedPreview.type === 'text' && pastedPreview.evaluation
                "
              >
                <strong>Nota:</strong>
                {{ pastedPreview.evaluation.rating || "N/A" }}/5
              </div>
            </div>
          </div>

          <div class="paste-help">
            <div class="help-tips">
              <h5>💡 Como usar:</h5>
              <ul>
                <li>
                  <strong>Receba</strong>: Alguém compartilha uma avaliação por
                  WhatsApp/Discord
                </li>
                <li>
                  <strong>Cole</strong>: Use Ctrl+V para colar o texto aqui
                </li>
                <li>
                  <strong>Importe</strong>: Clique em "Importar" para adicionar
                  à sua coleção
                </li>
              </ul>

              <div class="format-examples">
                <h6>📝 Formatos aceitos:</h6>
                <div class="format-item">
                  <strong>✅ Texto amigável:</strong> Compartilhamento casual
                  via mensagem
                </div>
                <div class="format-item">
                  <strong>✅ JSON exportado:</strong> Arquivo de exportação
                  completo
                </div>
              </div>
            </div>

            <div class="paste-shortcuts">
              <small
                ><strong>Atalhos:</strong> Ctrl+V para colar • Ctrl+A para
                selecionar tudo</small
              >
            </div>
          </div>
        </div>

        <!-- Tab de arquivo -->
        <div *ngIf="importTab === 'file'" class="file-import-section">
          <input
            type="file"
            accept=".json"
            (change)="onFileSelected($event)"
            #fileInput
            class="file-input"
            [disabled]="isImporting"
          />

          <div
            class="file-drop-zone"
            [class.drag-over]="isDragOver"
            [class.has-file]="selectedFile"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onFileDropped($event)"
            (click)="fileInput.click()"
          >
            <div *ngIf="!selectedFile" class="drop-zone-empty">
              <i class="drop-icon">☁️</i>
              <p class="drop-text">
                <strong>Arraste um arquivo JSON aqui</strong><br />
                ou clique para selecionar
              </p>
              <small>Máximo: 10MB</small>
            </div>

            <div *ngIf="selectedFile" class="drop-zone-file">
              <i class="file-icon">📄</i>
              <div class="file-info">
                <strong>{{ selectedFile.name }}</strong>
                <small>{{ (selectedFile.size / 1024).toFixed(1) }} KB</small>
              </div>
              <button
                class="remove-file-btn"
                (click)="
                  $event.stopPropagation();
                  selectedFile = null;
                  importPreview = null
                "
                [disabled]="isImporting"
              >
                ×
              </button>
            </div>
          </div>

          <!-- Preview do arquivo -->
          <div *ngIf="importPreview" class="import-preview">
            <h4>📊 Prévia da Importação:</h4>
            <div class="preview-info">
              <div class="preview-item">
                <strong>Total de avaliações:</strong> {{ importPreview.total }}
              </div>
              <div class="preview-item">
                <strong>Exportado por:</strong> {{ importPreview.exportedBy }}
              </div>
              <div class="preview-item" *ngIf="importPreview.exportedAt">
                <strong>Data da exportação:</strong>
                {{ importPreview.exportedAt | date : "dd/MM/yyyy HH:mm" }}
              </div>
              <div class="preview-item">
                <strong>Versão:</strong> {{ importPreview.version }}
              </div>
            </div>
          </div>
        </div>

        <!-- Tab de código -->
        <div *ngIf="importTab === 'code'" class="code-import-section">
          <div class="code-input-wrapper">
            <input
              type="text"
              placeholder="Digite o código de compartilhamento (ex: ABC12DE4)"
              [(ngModel)]="shareCode"
              class="share-code-input"
              [disabled]="isImporting"
              maxlength="16"
            />
          </div>

          <div class="code-help">
            <p class="help-text">
              <i>💡</i>
              O código de compartilhamento tem 8 caracteres e é fornecido quando
              alguém exporta avaliações.
            </p>
          </div>
        </div>
      </div>

      <!-- Modo de importação -->
      <div class="import-mode-section">
        <h4>Modo de Importação:</h4>
        <div class="mode-options">
          <label class="mode-option">
            <input
              type="radio"
              name="importMode"
              value="add"
              [(ngModel)]="importMode"
              [disabled]="isImporting"
            />
            <span class="mode-label">
              <strong>Adicionar</strong>
              <small>Manter existentes, adicionar novas</small>
            </span>
          </label>

          <label class="mode-option">
            <input
              type="radio"
              name="importMode"
              value="merge"
              [(ngModel)]="importMode"
              [disabled]="isImporting"
            />
            <span class="mode-label">
              <strong>Mesclar</strong>
              <small>Atualizar existentes, adicionar novas</small>
            </span>
          </label>

          <label class="mode-option">
            <input
              type="radio"
              name="importMode"
              value="replace"
              [(ngModel)]="importMode"
              [disabled]="isImporting"
            />
            <span class="mode-label">
              <strong>Substituir</strong>
              <small>Remover todas e importar novas</small>
            </span>
          </label>
        </div>

        <p class="mode-description">
          <i>ℹ️</i>
          {{ getImportModeDescription() }}
        </p>
      </div>
    </div>

    <div class="modal-actions">
      <button
        (click)="importEvaluations()"
        class="btn-primary"
        [disabled]="isImporting || !canImport()"
      >
        <span *ngIf="!isImporting">Importar</span>
        <span *ngIf="isImporting">
          <span class="spinner"></span>
          Importando...
        </span>
      </button>
      <button
        (click)="closeImportModal()"
        class="btn-secondary"
        [disabled]="isImporting"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal do formulário de avaliação -->
<app-evaluation-form
  *ngIf="isFormModalVisible"
  [evaluationData]="selectedEvaluation"
  (formSubmitted)="onFormSubmitted()"
  (formClosed)="onFormClosed()"
  (evaluationError)="onEvaluationError($event)"
></app-evaluation-form>
