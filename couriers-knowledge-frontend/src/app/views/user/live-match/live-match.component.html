<!-- couriers-knowledge-frontend/src/app/views/user/live-match/live-match.component.html -->

<div class="live-match-container">
  <!-- Header com t√≠tulo alinhado √† esquerda -->
  <div class="page-header">
    <h1>Partida Ao Vivo</h1>
    <button
      *ngIf="matchData"
      class="refresh-btn"
      (click)="resetForm()"
      title="Nova an√°lise">
      Nova An√°lise
    </button>
  </div>

  <!-- Formul√°rio de Status -->
  <div *ngIf="showInstructions || !matchData" class="status-form-section">
    <div class="instructions-card">
      <h3>Como usar</h3>
      <ol class="instructions-list">
        <li *ngFor="let instruction of instructions">{{ instruction }}</li>
      </ol>

      <div class="tips-section">
        <h4>Dicas</h4>
        <ul class="tips-list">
          <li *ngFor="let tip of systemTips">{{ tip }}</li>
        </ul>
      </div>
    </div>

    <div class="status-input-card">
      <h3>Cole o comando status aqui</h3>

      <div class="textarea-wrapper">
        <textarea
          [(ngModel)]="statusInput"
          placeholder="Cole aqui o resultado completo do comando 'status' do Dota 2..."
          class="status-textarea"
          rows="10"
          [disabled]="isProcessing">
        </textarea>

        <div class="input-actions">
          <button
            class="clear-btn"
            (click)="statusInput = ''"
            *ngIf="statusInput && !isProcessing"
            title="Limpar">
            Limpar
          </button>
        </div>
      </div>

      <div class="form-actions">
        <button
          class="analyze-btn"
          [disabled]="!statusInput || isProcessing"
          (click)="analyzeStatus()">
          <span *ngIf="!isProcessing">Analisar Status</span>
          <span *ngIf="isProcessing">Processando...</span>
        </button>

        <button
          class="reset-btn"
          *ngIf="matchData"
          (click)="resetForm()">
          Nova An√°lise
        </button>
      </div>

      <!-- Error Display -->
      <div *ngIf="error" class="error-message">
        <span class="error-icon">‚ùå</span>
        <span>{{ error }}</span>
      </div>
    </div>
  </div>

  <!-- Resultados da Partida -->
  <div *ngIf="matchData && !showInstructions" class="match-results">
    <!-- Header da Partida -->
    <div class="match-header">
      <div class="game-state">
        <h2>{{ matchData.gameState.translated }}</h2>
      </div>

      <div class="match-info">
        <div class="info-item">
          <span class="info-label">Total de Jogadores:</span>
          <span class="info-value">{{ matchData.statistics.totalPlayers }}</span>
        </div>
        <div class="info-item" *ngIf="hasEvaluations()">
          <span class="info-label">Com Avalia√ß√µes:</span>
          <span class="info-value highlight">{{ matchData.statistics.evaluatedPlayers }}</span>
        </div>
        <div class="info-item" *ngIf="matchData.evaluationsSummary.totalFound > 0">
          <span class="info-label">Total de Avalia√ß√µes:</span>
          <span class="info-value">{{ matchData.evaluationsSummary.totalFound }}</span>
        </div>
      </div>

      <button class="refresh-btn-small" (click)="resetForm()" title="Nova an√°lise">
        <span class="refresh-icon">üîÑ</span>
      </button>
    </div>

    <!-- Times -->
    <div class="teams-container">
      <!-- Time Radiant -->
      <div class="team-section radiant">
        <h3 class="team-title">
          Iluminados
        </h3>

        <div class="players-list">
          <div
            *ngFor="let player of matchData.teams.radiant"
            class="player-card"
            [class.has-evaluations]="player.hasEvaluations"
            [class.is-bot]="player.isBot">

            <!-- Player Info -->
            <div class="player-info">
              <div class="player-name">
                {{ player.name }}
                <span *ngIf="player.isBot" class="bot-badge">BOT</span>
              </div>
            </div>

            <!-- Evaluation Stats -->
            <div *ngIf="player.hasEvaluations && player.stats && canViewDetails()" class="evaluation-stats">
              <div class="rating-display">
                <span
                  class="rating-value"
                  [style.color]="getRatingColor(player.stats.averageRating)">
                  {{ formatRating(player.stats.averageRating) }}/5
                </span>
                <span class="evaluation-count">({{ player.stats.totalEvaluations }})</span>
              </div>

              <div class="tags-preview" *ngIf="player.stats.allTags && player.stats.allTags.length > 0">
                <span
                  *ngFor="let tag of player.stats.allTags.slice(0, 3)"
                  class="tag-mini">
                  #{{ tag }}
                </span>
                <span *ngIf="player.stats.allTags.length > 3" class="more-tags">
                  +{{ player.stats.allTags.length - 3 }}
                </span>
              </div>
            </div>

            <!-- Actions -->
            <div class="player-actions">
              <button
                *ngIf="player.hasEvaluations && canViewDetails()"
                class="details-btn"
                (click)="showPlayerDetails(player)"
                title="Ver avalia√ß√µes">
                Detalhes
              </button>

              <!-- Mensagem para usu√°rios sem acesso -->
              <div *ngIf="player.hasEvaluations && !canViewDetails()" class="premium-required">
                <span class="premium-text">Premium necess√°rio</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Time Dire -->
      <div class="team-section dire">
        <h3 class="team-title">
          Temidos
        </h3>

        <div class="players-list">
          <div
            *ngFor="let player of matchData.teams.dire"
            class="player-card"
            [class.has-evaluations]="player.hasEvaluations"
            [class.is-bot]="player.isBot">

            <!-- Player Info -->
            <div class="player-info">
              <div class="player-name">
                {{ player.name }}
                <span *ngIf="player.isBot" class="bot-badge">BOT</span>
              </div>
            </div>

            <!-- Evaluation Stats -->
            <div *ngIf="player.hasEvaluations && player.stats && canViewDetails()" class="evaluation-stats">
              <div class="rating-display">
                <span
                  class="rating-value"
                  [style.color]="getRatingColor(player.stats.averageRating)">
                  {{ formatRating(player.stats.averageRating) }}/5
                </span>
                <span class="evaluation-count">({{ player.stats.totalEvaluations }})</span>
              </div>

              <div class="tags-preview" *ngIf="player.stats.allTags && player.stats.allTags.length > 0">
                <span
                  *ngFor="let tag of player.stats.allTags.slice(0, 3)"
                  class="tag-mini">
                  #{{ tag }}
                </span>
                <span *ngIf="player.stats.allTags.length > 3" class="more-tags">
                  +{{ player.stats.allTags.length - 3 }}
                </span>
              </div>
            </div>

            <!-- Actions -->
            <div class="player-actions">
              <button
                *ngIf="player.hasEvaluations && canViewDetails()"
                class="details-btn"
                (click)="showPlayerDetails(player)"
                title="Ver avalia√ß√µes">
                Detalhes
              </button>

              <!-- Mensagem para usu√°rios sem acesso -->
              <div *ngIf="player.hasEvaluations && !canViewDetails()" class="premium-required">
                <span class="premium-text">Premium necess√°rio</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="match-summary" *ngIf="matchData.evaluationsSummary.totalFound > 0">
      <h4>Resumo das Avalia√ß√µes</h4>
      <div class="summary-content">
        <p>
          Encontradas <strong>{{ matchData.evaluationsSummary.totalFound }}</strong> avalia√ß√µes
          para <strong>{{ matchData.evaluationsSummary.playersWithEvaluations }}</strong> jogadores.
        </p>
        <div class="evaluated-players-list">
          <span class="players-label">Jogadores avaliados:</span>
          <div class="players-tags">
            <span
              *ngFor="let playerName of matchData.evaluationsSummary.playerNames"
              class="player-tag">
              {{ playerName }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- No Evaluations Message -->
    <div class="no-evaluations-message" *ngIf="matchData && !hasEvaluations()">
      <h4>Primeira vez jogando com estes jogadores?</h4>
      <p>Nenhum dos jogadores desta partida possui avalia√ß√µes no seu hist√≥rico.</p>
      <p>Este √© o momento perfeito para conhecer novos estilos de jogo!</p>
    </div>
  </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal-overlay" *ngIf="isDetailModalVisible" (click)="closeDetailModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Avalia√ß√µes de {{ selectedPlayerForDetails?.name }}</h3>
      <button class="close-btn" (click)="closeDetailModal()">√ó</button>
    </div>

    <div class="modal-body">
      <div *ngIf="selectedPlayerForDetails?.stats" class="player-summary">
        <div class="summary-stat">
          <span class="label">Nota M√©dia:</span>
          <span
            class="value"
            [style.color]="getRatingColor(selectedPlayerForDetails!.stats!.averageRating)">
            {{ formatRating(selectedPlayerForDetails!.stats!.averageRating) }}/5
          </span>
        </div>
        <div class="summary-stat">
          <span class="label">Total de Avalia√ß√µes:</span>
          <span class="value">{{ selectedPlayerForDetails!.stats!.totalEvaluations }}</span>
        </div>
        <div class="summary-stat" *ngIf="selectedPlayerForDetails!.stats!.mostCommonRole">
          <span class="label">Fun√ß√£o Mais Comum:</span>
          <span class="value">{{ selectedPlayerForDetails!.stats!.mostCommonRole!.toUpperCase() }}</span>
        </div>
      </div>

      <div class="evaluations-list">
        <div
          *ngFor="let evaluation of selectedPlayerForDetails?.evaluations"
          class="evaluation-item">

          <div class="evaluation-header">
            <app-rating-display [rating]="evaluation.rating"></app-rating-display>
            <span class="evaluation-date">{{ formatDate(evaluation.created_at) }}</span>
          </div>

          <div class="evaluation-context" *ngIf="evaluation.hero_id || evaluation.role">
            <img
              *ngIf="evaluation.hero_id"
              [src]="gameDataService.getHeroImageUrl(evaluation.hero_id)"
              [alt]="gameDataService.getHeroById(evaluation.hero_id)"
              class="hero-icon-tiny">
            <span *ngIf="evaluation.role" class="role-info">{{ evaluation.role.toUpperCase() }}</span>
          </div>

          <div *ngIf="evaluation.notes" class="evaluation-notes">
            {{ evaluation.notes }}
          </div>

          <div class="evaluation-tags" *ngIf="evaluation.tags && evaluation.tags.length > 0">
            <span *ngFor="let tag of evaluation.tags" class="tag-badge">#{{ tag }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Audio element for notification sound -->
<audio #notificationSound preload="auto">
  <source src="assets/sounds/notification.mp3" type="audio/mpeg">
  <source src="assets/sounds/notification.ogg" type="audio/ogg">
</audio>
