<div class="leaderboard-container">
  <!-- Header -->
  <div class="header-section">
    <div class="header-info">
      <h1 class="page-title">Europe Leaderboard</h1>
      <p class="page-subtitle">Gerenciamento de players conhecidos - Região Europa</p>
      @if (lastUpdate()) {
        <p class="last-update">
          Última atualização: {{ lastUpdate() | date:'dd/MM/yyyy HH:mm' }}
        </p>
      }
    </div>

    <div class="header-actions">
      <button
        (click)="refreshLeaderboard()"
        [disabled]="loading()"
        class="btn btn-primary"
      >
        <svg class="btn-icon" [class.animate-spin]="loading()" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Atualizar
      </button>

      <button
        (click)="showAddModal.set(true)"
        class="btn btn-success"
      >
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Adicionar Player
      </button>

      <button
        (click)="exportLeaderboardData()"
        class="btn btn-secondary"
        title="Exportar dados em CSV"
      >
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Exportar
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-container">
      <div class="search-input-wrapper">
        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="text"
          placeholder="Buscar por nome competitivo, Steam name ou SteamID..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          class="search-input"
        />
      </div>
    </div>

    <select
      [(ngModel)]="filterConfidence"
      (change)="onFilterChange()"
      class="filter-select"
    >
      <option value="all">Todos os status</option>
      <option value="known">Conhecidos</option>
      <option value="unknown">Desconhecidos</option>
    </select>

    <div class="results-info">
      Mostrando {{ filteredPlayers().length }} de {{ players().length }} players
    </div>
  </div>

  <!-- Stats Cards -->
  @if (stats()) {
    <div class="stats-grid">
      <div class="stats-card stats-card-confirmed">
        <div class="stats-header">
          <svg class="stats-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          <span class="stats-label">Conhecidos</span>
        </div>
        <p class="stats-value">{{ stats()?.confirmed || 0 }}</p>
      </div>

      <div class="stats-card stats-card-unknown">
        <div class="stats-header">
          <svg class="stats-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span class="stats-label">Desconhecidos</span>
        </div>
        <p class="stats-value">{{ (players().length - (stats()?.confirmed || 0)) }}</p>
      </div>

      <div class="stats-card stats-card-total">
        <div class="stats-header">
          <svg class="stats-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <span class="stats-label">Total Players</span>
        </div>
        <p class="stats-value">{{ players().length }}</p>
      </div>

      <div class="stats-card stats-card-observation">
        <div class="stats-header">
          <svg class="stats-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="stats-label">Taxa Conhecidos</span>
        </div>
        <p class="stats-value">{{ players().length > 0 ? Math.round(((stats()?.confirmed || 0) / players().length) * 100) : 0 }}%</p>
      </div>
    </div>
  }

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Carregando leaderboard da Europa...</p>
    </div>
  }

  <!-- Leaderboard Table -->
  @if (!loading() && filteredPlayers().length > 0) {
    <div class="table-container">
      <div class="table-wrapper">
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Nome Competitivo</th>
              <th>Nome Steam</th>
              <th>SteamID</th>
              <th>País</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            @for (player of filteredPlayers(); track player.rank) {
              <tr class="table-row" [class.known-player]="isPlayerKnown(player)">
                <!-- Rank -->
                <td>
                  <div class="rank-cell">
                    <span class="rank-number">#{{ player.rank }}</span>
                    @if (getRankChange(player)) {
                      <span [class]="getRankChangeClass(player)">
                        {{ getRankChange(player) }}
                      </span>
                    }
                  </div>
                </td>

                <!-- Nome Competitivo (com Team Tag) -->
                <td>
                  <div class="competitive-name-cell">
                    @if (player.teamTag) {
                      <span class="team-prefix">{{ player.teamTag }}</span>
                    }
                    <span class="competitive-name" [title]="'Nome que aparece no leaderboard oficial: ' + player.competitiveName">
                      {{ getPlayerCompetitiveName(player) }}
                    </span>
                    @if (player.knownPlayer?.competitive_name && player.knownPlayer!.competitive_name !== player.competitiveName) {
                      <span class="original-name" title="Nome original do scraping">
                        ({{ player.competitiveName }})
                      </span>
                    }
                  </div>
                </td>

                <!-- Nome Steam -->
                <td>
                  <div class="steam-name-cell">
                    @if (player.knownPlayer?.steam_name) {
                      <span class="steam-name confirmed">{{ player.knownPlayer!.steam_name }}</span>
                    } @else if (player.steamName) {
                      <span class="steam-name unconfirmed">{{ player.steamName }}</span>
                    } @else {
                      <span class="steam-name-placeholder">
                        Não linkado
                        <button
                          (click)="linkSteamProfile(player)"
                          class="link-btn"
                          title="Linkar perfil Steam"
                        >
                          Link
                        </button>
                      </span>
                    }
                  </div>
                </td>

                <!-- SteamID -->
                <td>
                  <div class="steam-id-cell">
                    <span class="steam-id">{{ player.steamId.substring(0, 8) }}...</span>
                    <a
                      [href]="getSteamProfileUrl(player.steamId)"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="steam-link"
                      title="Abrir perfil Steam"
                    >
                      <svg class="external-link-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </a>
                  </div>
                </td>

                <!-- País (com bandeira) -->
                <td>
                  <div class="team-country-cell">
                    @if (player.country) {
                      <div class="country-flag">
                        <img
                          [src]="'https://flagcdn.com/16x12/' + player.country.toLowerCase() + '.png'"
                          [alt]="player.country + ' flag'"
                          class="flag-image"
                          [title]="player.country"
                        />
                        <span class="country-code">{{ player.country }}</span>
                      </div>
                    } @else {
                      <span class="no-info">-</span>
                    }
                  </div>
                </td>

                <!-- Status (Conhecido/Desconhecido) -->
                <td>
                  <div class="confidence-cell">
                    @if (isPlayerKnown(player)) {
                      <div class="status-badge status-confirmed" title="Player conhecido e confirmado">
                        <svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Conhecido
                      </div>
                    } @else {
                      <div class="status-badge status-unknown" title="Player desconhecido">
                        <svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Desconhecido
                      </div>
                    }

                    <!-- Volatility Info -->
                    <div class="volatility-info" [title]="getVolatilityInfo(player.rank)">
                      {{ getVolatilityInfo(player.rank).split(':')[1]?.trim() || getVolatilityInfo(player.rank) }}
                    </div>
                  </div>
                </td>

                <!-- Ações -->
                <td>
                  <div class="actions-cell">
                    @if (player.knownPlayer) {
                      <!-- Player conhecido - ações de edição -->
                      <button
                        (click)="editPlayer(player.knownPlayer)"
                        class="action-btn action-edit"
                        title="Editar player conhecido"
                      >
                        <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      </button>
                      <button
                        (click)="deletePlayer(player.knownPlayer.id)"
                        class="action-btn action-delete"
                        title="Remover player conhecido"
                      >
                        <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    } @else {
                      <!-- Player desconhecido - ação de adicionar -->
                      <button
                        (click)="quickAddPlayer(player)"
                        class="action-btn action-add"
                        title="Adicionar como player conhecido"
                      >
                        <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Adicionar
                      </button>
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && filteredPlayers().length === 0 && players().length > 0) {
    <div class="empty-state">
      <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <h3>Nenhum player encontrado</h3>
      <p>Tente ajustar os filtros de busca</p>
    </div>
  }

  @if (!loading() && players().length === 0) {
    <div class="empty-state">
      <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
      </svg>
      <h3>Leaderboard não disponível</h3>
      <p>Erro ao carregar dados do backend. Tente atualizar a página.</p>
    </div>
  }

  <!-- Add Player Modal -->
  @if (showAddModal()) {
    <div class="modal-backdrop">
      <div class="modal-content">
        <h3 class="modal-title">Adicionar Player Conhecido</h3>

        <form class="modal-form">
          <div class="form-group">
            <label class="form-label">Perfil Steam (URL ou SteamID64)</label>
            <input
              type="text"
              [(ngModel)]="steamProfileUrl"
              name="steamUrl"
              placeholder="https://steamcommunity.com/id/username ou https://steamcommunity.com/profiles/76561198..."
              class="form-input"
            />
            <small class="form-help">Cole a URL do perfil Steam do player</small>
          </div>

          <div class="form-group">
            <label class="form-label">Nome Competitivo</label>
            <input
              type="text"
              [(ngModel)]="competitiveName"
              name="competitiveName"
              placeholder="Nome usado em competições e tournaments"
              class="form-input"
            />
            <small class="form-help">Este é o nome que aparece no leaderboard oficial</small>
          </div>

          <div class="form-group">
            <label class="form-label">Rank Atual (opcional)</label>
            <input
              type="number"
              [(ngModel)]="playerRank"
              name="playerRank"
              placeholder="Ex: 150"
              min="1"
              max="10000"
              class="form-input"
            />
          </div>

          <div class="form-group">
            <label class="form-label">Região</label>
            <select
              [(ngModel)]="selectedRegion"
              name="selectedRegion"
              class="form-select"
            >
              <option value="europe">Europa</option>
              <option value="americas">Américas</option>
              <option value="se_asia">Ásia</option>
              <option value="china">China</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <textarea
              [(ngModel)]="notes"
              name="notes"
              placeholder="Informações adicionais sobre o player..."
              rows="3"
              class="form-textarea"
            ></textarea>
          </div>
        </form>

        <div class="modal-actions">
          <button (click)="closeAddModal()" class="btn btn-secondary">
            Cancelar
          </button>
          <button
            (click)="addPlayer()"
            [disabled]="!steamProfileUrl() || !competitiveName()"
            class="btn btn-primary"
          >
            Adicionar Player
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Edit Player Modal -->
  @if (editingPlayer()) {
    <div class="modal-backdrop">
      <div class="modal-content">
        <h3 class="modal-title">Editar Player Conhecido</h3>

        <form class="modal-form">
          <div class="form-group">
            <label class="form-label">SteamID64</label>
            <input
              type="text"
              [value]="editingPlayer()?.steam_id"
              disabled
              class="form-input form-input-disabled"
            />
            <small class="form-help">O SteamID não pode ser alterado</small>
          </div>

          <div class="form-group">
            <label class="form-label">Nome Competitivo</label>
            <input
              type="text"
              [(ngModel)]="competitiveName"
              name="competitiveName"
              placeholder="Nome usado em competições"
              class="form-input"
            />
            <small class="form-help">Nome que o player usa oficialmente em tournaments</small>
          </div>

          <div class="form-group">
            <label class="form-label">Nome Steam Atual</label>
            <input
              type="text"
              [value]="editingPlayer()?.steam_name || 'Não definido'"
              disabled
              class="form-input form-input-disabled"
            />
            <small class="form-help">Nome atual do perfil Steam (atualizado automaticamente)</small>
          </div>

          <div class="form-group">
            <label class="form-label">Nível de Confiança</label>
            <select [(ngModel)]="editConfidenceLevel" name="confidenceLevel" class="form-select">
              <option value="confirmed">Confirmado (100%)</option>
              <option value="high">Alta confiança (95%)</option>
              <option value="medium">Média confiança (80%)</option>
              <option value="observation">Em observação (60%)</option>
              <option value="unknown">Desconhecido (0%)</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Status</label>
            <select [(ngModel)]="editStatus" name="status" class="form-select">
              <option value="active">Ativo</option>
              <option value="missing">Ausente</option>
              <option value="inactive">Inativo</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Notas</label>
            <textarea
              [(ngModel)]="notes"
              name="notes"
              placeholder="Informações adicionais..."
              rows="3"
              class="form-textarea"
            ></textarea>
          </div>
        </form>

        <div class="modal-actions">
          <button (click)="closeEditModal()" class="btn btn-secondary">
            Cancelar
          </button>
          <button (click)="updatePlayer()" class="btn btn-primary">
            Salvar Alterações
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Volatility Sectors Info -->
  <div class="info-section">
    <h3 class="info-title">🎯 Sistema de Volatilidade - Europa</h3>
    <div class="volatility-grid">
      <div class="volatility-group">
        <h4>Ranks 1-100</h4>
        <p><strong>±100</strong> volatilidade</p>
        <small>Elite mundial</small>
      </div>
      <div class="volatility-group">
        <h4>Ranks 101-500</h4>
        <p><strong>±200</strong> volatilidade</p>
        <small>Professional tier</small>
      </div>
      <div class="volatility-group">
        <h4>Ranks 501-1000</h4>
        <p><strong>±300</strong> volatilidade</p>
        <small>Semi-professional</small>
      </div>
      <div class="volatility-group">
        <h4>Ranks 1001-2000</h4>
        <p><strong>±400</strong> volatilidade</p>
        <small>High immortal</small>
      </div>
      <div class="volatility-group">
        <h4>Ranks 2001-3000</h4>
        <p><strong>±500</strong> volatilidade</p>
        <small>Mid immortal</small>
      </div>
      <div class="volatility-group">
        <h4>Ranks 3001-4000</h4>
        <p><strong>Zona adaptação</strong></p>
        <small>Observação especial</small>
      </div>
    </div>
    <div class="info-note">
      <p>💡 <strong>Players na zona de adaptação</strong> (3001-4000) ficam em observação especial para garantir 100% de confiabilidade do top 3000.</p>
      <p>🔗 <strong>Sistema de links:</strong> O nome competitivo vem do scraping oficial. Admins podem linkar perfis Steam para obter o nome real.</p>
    </div>
  </div>

  <!-- Recent Changes Log -->
  @if (recentChanges().length > 0) {
    <div class="changes-section">
      <div class="changes-header">
        <h3 class="changes-title">📝 Mudanças Recentes</h3>
      </div>
      <div class="changes-content">
        <div class="changes-list">
          @for (change of recentChanges().slice(0, 10); track change.detected_at) {
            <div class="change-item">
              @switch (change.change_type) {
                @case ('volatility_alert') {
                  <svg class="change-icon change-icon-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                  </svg>
                }
                @case ('new_known_player') {
                  <svg class="change-icon change-icon-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                }
                @default {
                  <svg class="change-icon change-icon-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                }
              }
              <span class="change-time">{{ change.detected_at | date:'HH:mm' }}</span>
              <span class="change-description">{{ formatChangeDescription(change) }}</span>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
