<!-- ===== MODAL OVERLAY COM CORREÇÃO DE MOUSE DRAG ===== -->
<div class="modal-overlay">
  <div class="modal-content"
       (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ (isEditMode ? 'evaluation.form.edit.title' : 'evaluation.form.new.title') | translate }}</h2>
      <div class="step-indicator" *ngIf="!isEditMode">
        {{ 'evaluation.form.step.indicator' | translate}}{{currentStep}}{{'evaluation.form.step.indicator2' | translate}}
      </div>
      <button class="close-btn" (click)="onClose()">{{ 'evaluation.form.close' | translate }}</button>
    </div>

    <form [formGroup]="evaluationForm" (ngSubmit)="submitForm()">
      <div *ngIf="currentStep === 1">
        <fieldset class="form-section">
          <legend>{{ 'evaluation.form.section1.title' | translate }}</legend>
          <div class="form-row">
            <div class="form-group">
              <label for="targetSteamId">{{ 'evaluation.form.player.steamid' | translate }}</label>

              <!-- ✅ INPUT NORMAL (quando não bloqueado) -->
              <input
                *ngIf="
                  !shouldLockFields ||
                  !evaluationForm.get('targetSteamId')?.disabled
                "
                type="text"
                id="targetSteamId"
                formControlName="targetSteamId"
                [placeholder]="'evaluation.form.steamid.placeholder' | translate"
                maxlength="17"
              />

              <!-- ✅ CAMPO VISUAL PLAYER (quando bloqueado) -->
              <div
                *ngIf="
                  shouldLockFields &&
                  evaluationForm.get('targetSteamId')?.disabled
                "
                class="prefilled-field"
              >
                <div class="prefilled-content">
                  <div class="player-info">
                    <strong>{{
                      prefilledPlayerName || ('evaluation.form.player.match' | translate)
                    }}</strong>
                    <small>{{
                      evaluationForm.get("targetSteamId")?.value
                    }}</small>
                  </div>
                  <span class="prefilled-badge">{{
                    (isEditMode ? 'evaluation.form.badge.fixed' : 'evaluation.form.badge.from.match') | translate
                  }}</span>
                </div>
              </div>

              <div
                *ngIf="
                  evaluationForm.get('targetSteamId')?.invalid &&
                  evaluationForm.get('targetSteamId')?.touched &&
                  !evaluationForm.get('targetSteamId')?.disabled
                "
                class="error-message"
              >
                {{ 'evaluation.form.steamid.error' | translate }}
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset class="form-section">
          <legend>{{ 'evaluation.form.section2.title' | translate }}</legend>

          <!-- ===== PRIMEIRA LINHA: MATCH ID E HERÓI ===== -->
          <div class="form-row">
            <!-- ===== CAMPO DE MATCH ID ===== -->
            <div class="form-group">
              <label for="matchId">{{ 'evaluation.form.match.id' | translate }}</label>

              <!-- ✅ INPUT NORMAL (quando não bloqueado) -->
              <input
                *ngIf="
                  !shouldLockFields || !evaluationForm.get('matchId')?.disabled
                "
                type="text"
                id="matchId"
                formControlName="matchId"
                [placeholder]="'evaluation.form.matchid.placeholder' | translate"
              />

              <!-- ✅ CAMPO VISUAL MATCH (quando bloqueado) -->
              <div
                *ngIf="
                  shouldLockFields && evaluationForm.get('matchId')?.disabled
                "
                class="prefilled-field"
              >
                <div class="prefilled-content">
                  <div class="match-info">
                    <strong>{{ getMatchDisplayText() }}</strong>
                    <small>{{
                        (isEditMode
                          ? 'evaluation.form.cannot.change'
                          : 'evaluation.form.auto.detected') | translate
                      }}</small>
                  </div>
                  <span class="prefilled-badge">{{
                    (isEditMode ? 'evaluation.form.badge.fixed' : 'evaluation.form.badge.from.match') | translate
                  }}</span>
                </div>
              </div>
            </div>

            <!-- ===== CAMPO DE HERÓI ===== -->
            <div class="form-group">
              <label for="hero_id">{{ 'evaluation.form.hero.played' | translate }}</label>

              <!-- ✅ SELECT NORMAL (quando não bloqueado) -->
              <select
                *ngIf="
                  !shouldLockFields || !evaluationForm.get('hero_id')?.disabled
                "
                id="hero_id"
                formControlName="hero_id"
              >
                <option [ngValue]="null">{{ 'evaluation.form.do.not.inform' | translate }}</option>
                <option *ngFor="let hero of heroes$ | async" [value]="hero.id">
                  {{ hero.localized_name }}
                </option>
              </select>

              <!-- ✅ CAMPO VISUAL HERÓI (quando bloqueado) -->
              <div
                *ngIf="
                  shouldLockFields && evaluationForm.get('hero_id')?.disabled
                "
                class="prefilled-field"
              >
                <div class="prefilled-content">
                  <div class="hero-info">
                    <img
                      [src]="
                        gameDataService.getHeroImageUrl(
                          evaluationForm.get('hero_id')?.value
                        )
                      "
                      class="hero-icon-prefilled"
                      [alt]="prefilledHeroName"
                    />
                    <div class="hero-details">
                      <strong>{{
                        prefilledHeroName || ('evaluation.form.hero.match' | translate)
                      }}</strong>
                      <small>{{
                        (isEditMode
                          ? 'evaluation.form.cannot.change'
                          : 'evaluation.form.auto.detected') | translate
                      }}</small>
                    </div>
                  </div>
                  <span class="prefilled-badge">{{
                    (isEditMode ? 'evaluation.form.badge.fixed' : 'evaluation.form.badge.from.match') | translate
                  }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== SEGUNDA LINHA: FUNÇÃO (SEMPRE EDITÁVEL) ===== -->
          <div class="form-row">
            <div class="form-group role-field-group">
              <label for="role">
                {{ 'evaluation.form.role' | translate }}
                <span *ngIf="shouldLockFields" class="editable-hint">{{ 'evaluation.form.role.editable' | translate }}</span>
              </label>
              <select id="role" formControlName="role" class="role-select">
                <option [ngValue]="null">{{ 'evaluation.form.do.not.inform' | translate }}</option>
                <option *ngFor="let role of roles" [value]="role">
                  {{ getRoleDisplayName(role) }}
                </option>
              </select>
            </div>
          </div>
        </fieldset>
      </div>

      <div *ngIf="currentStep === 2">
        <fieldset class="form-section">
          <legend>{{ 'evaluation.form.section3.title' | translate }}</legend>
          <div class="form-group rating-group">
            <label>{{ 'evaluation.form.rating' | translate }}</label>
            <div class="rating-input-container">
              <div
                *ngFor="let i of [1, 2, 3, 4, 5]"
                class="rating-input-square"
                (click)="setRating(i)"
                (mouseenter)="hoverRating = i"
                (mouseleave)="hoverRating = 0"
              >
                <div
                  class="rating-square-inner"
                  [ngClass]="{
                    filled:
                      (hoverRating || evaluationForm.get('rating')?.value) >= i,
                    half:
                      (hoverRating || evaluationForm.get('rating')?.value) ===
                      i - 0.5
                  }"
                  (mousedown)="$event.preventDefault()"
                >
                  <div
                    class="half-left"
                    (click)="setRating(i - 0.5, $event)"
                    (mouseenter)="hoverRating = i - 0.5"
                  ></div>
                  <div
                    class="half-right"
                    (click)="setRating(i, $event)"
                    (mouseenter)="hoverRating = i"
                  ></div>
                </div>
              </div>
            </div>
            <div
              *ngIf="
                evaluationForm.get('rating')?.invalid &&
                evaluationForm.get('rating')?.touched
              "
              class="error-message"
            >
              {{ 'evaluation.form.rating.required' | translate }}
            </div>
          </div>

          <div class="form-group">
            <label for="tags">{{ 'evaluation.form.tags' | translate }}</label>
            <input
              id="tags"
              type="text"
              formControlName="tags"
              class="form-control"
              [placeholder]="'evaluation.form.tags.placeholder' | translate"
              (input)="onTagsInput($event)"
            />
            <div
              class="tag-suggestions"
              *ngIf="suggestedTags$ | async as suggestions"
            >
              <span *ngIf="suggestions.length > 0">{{ 'evaluation.form.suggestions' | translate }}</span>
              <button
                type="button"
                *ngFor="let tag of suggestions"
                class="tag-suggestion-btn"
                (click)="addTag(tag)"
                (mousedown)="$event.preventDefault()"
              >
                {{ tag }}
              </button>
            </div>
            <div
              *ngIf="evaluationForm.get('tags')?.errors as errors"
              class="error-message"
            >
              <span *ngIf="errors['maxTags']">{{ 'evaluation.form.tags.max.error' | translate }}</span>
              <span *ngIf="errors['maxTagLength']">{{ 'evaluation.form.tag.too.long.error' | translate:{tag: errors['maxTagLength'].value} }}</span>
            </div>
          </div>

          <div class="form-group">
            <label for="notes">{{ 'evaluation.form.notes' | translate }}</label>
            <textarea
              id="notes"
              rows="4"
              formControlName="notes"
              class="form-control"
              [placeholder]="'evaluation.form.notes.placeholder' | translate"
            ></textarea>
            <div
              class="char-counter"
              [class.error]="evaluationForm.get('notes')?.errors?.['maxlength']"
            >
              {{ evaluationForm.get("notes")?.value?.length || 0 }} / 200
            </div>
          </div>
        </fieldset>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="onClose()">
          {{ 'evaluation.form.cancel' | translate }}
        </button>
        <button
          type="button"
          class="btn-tertiary"
          *ngIf="currentStep === 2 && !isEditMode"
          (click)="prevStep()"
        >
          {{ 'evaluation.form.back' | translate }}
        </button>
        <button
          type="button"
          class="btn-primary"
          *ngIf="currentStep === 1"
          (click)="nextStep()"
          [disabled]="
            evaluationForm.get('targetSteamId')?.invalid &&
            !evaluationForm.get('targetSteamId')?.disabled
          "
        >
          {{ 'evaluation.form.next' | translate }}
        </button>
        <button
          type="submit"
          class="btn-primary"
          *ngIf="currentStep === 2"
          [disabled]="evaluationForm.invalid"
        >
          {{ (isEditMode ? 'evaluation.form.save.changes' : 'evaluation.form.create') | translate }}
        </button>
      </div>
    </form>
  </div>
</div>
