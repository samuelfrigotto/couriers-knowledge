<div class="modal-overlay" (click)="onClose()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditMode ? "Editar Avalia√ß√£o" : "Nova Avalia√ß√£o" }}</h2>
      <div class="step-indicator" *ngIf="!isEditMode">
        Passo {{ currentStep }} de 2
      </div>
      <button class="close-btn" (click)="onClose()">&times;</button>
    </div>

    <form [formGroup]="evaluationForm" (ngSubmit)="submitForm()">
      <div *ngIf="currentStep === 1">
        <fieldset class="form-section">
          <legend>1. Identifica√ß√£o do Jogador</legend>
          <div class="form-row">
            <div class="form-group">
              <label for="targetSteamId">Steam ID do Jogador</label>

              <!-- ‚úÖ INPUT NORMAL (quando n√£o bloqueado) -->
              <input
                *ngIf="
                  !shouldLockFields ||
                  !evaluationForm.get('targetSteamId')?.disabled
                "
                type="text"
                id="targetSteamId"
                formControlName="targetSteamId"
                placeholder="Exemplo: 76561198012345678"
                maxlength="17"
              />

              <!-- ‚úÖ CAMPO VISUAL PLAYER (quando bloqueado) -->
              <div
                *ngIf="
                  shouldLockFields &&
                  evaluationForm.get('targetSteamId')?.disabled
                "
                class="prefilled-field"
              >
                <div class="prefilled-content">
                  <div class="player-info">
                    <strong>{{
                      prefilledPlayerName || "Jogador da Partida"
                    }}</strong>
                    <small>{{
                      evaluationForm.get("targetSteamId")?.value
                    }}</small>
                  </div>
                  <span class="prefilled-badge">{{
                    isEditMode ? "Fixo" : "Da Partida"
                  }}</span>
                </div>
              </div>

              <div
                *ngIf="
                  evaluationForm.get('targetSteamId')?.invalid &&
                  evaluationForm.get('targetSteamId')?.touched &&
                  !evaluationForm.get('targetSteamId')?.disabled
                "
                class="error-message"
              >
                Deve ser um n√∫mero de 17 d√≠gitos.
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset class="form-section">
          <legend>2. Contexto da Partida (Opcional)</legend>
          <div class="form-row">
            <!-- ===== CAMPO DE MATCH ID ===== -->
            <div class="form-group">
              <label for="matchId">ID da Partida</label>

              <!-- ‚úÖ INPUT NORMAL (quando n√£o bloqueado) -->
              <input
                *ngIf="
                  !shouldLockFields || !evaluationForm.get('matchId')?.disabled
                "
                type="text"
                id="matchId"
                formControlName="matchId"
                placeholder="Exemplo: 1234567890"
              />

              <!-- ‚úÖ CAMPO VISUAL MATCH (quando bloqueado) -->
              <div
                *ngIf="
                  shouldLockFields && evaluationForm.get('matchId')?.disabled
                "
                class="prefilled-field"
              >
                <div class="prefilled-content">
                  <div class="match-info">
                    <strong>{{ getMatchDisplayText() }}</strong>
                    <small>Partida detectada automaticamente</small>
                  </div>
                  <span class="prefilled-badge">{{
                    isEditMode ? "Fixo" : "Da Partida"
                  }}</span>
                </div>
              </div>
            </div>

            <!-- ===== CAMPO DE HER√ìI ===== -->
            <div class="form-group">
              <label for="hero_id">Her√≥i Jogado</label>

              <!-- ‚úÖ SELECT NORMAL (quando n√£o bloqueado) -->
              <select
                *ngIf="
                  !shouldLockFields || !evaluationForm.get('hero_id')?.disabled
                "
                id="hero_id"
                formControlName="hero_id"
              >
                <option [ngValue]="null">N√£o informar</option>
                <option *ngFor="let hero of heroes$ | async" [value]="hero.id">
                  {{ hero.localized_name }}
                </option>
              </select>

              <!-- ‚úÖ CAMPO VISUAL HER√ìI (quando bloqueado) -->
              <div
                *ngIf="
                  shouldLockFields && evaluationForm.get('hero_id')?.disabled
                "
                class="prefilled-field"
              >
                <div class="prefilled-content">
                  <div class="hero-info">
                    <img
                      [src]="
                        gameDataService.getHeroImageUrl(
                          evaluationForm.get('hero_id')?.value
                        )
                      "
                      class="hero-icon-prefilled"
                      [alt]="prefilledHeroName"
                    />
                    <div class="hero-details">
                      <strong>{{
                        prefilledHeroName || "Her√≥i da Partida"
                      }}</strong>
                      <small>{{
                        isEditMode
                          ? "N√£o √© poss√≠vel alterar"
                          : "Detectado automaticamente"
                      }}</small>
                    </div>
                  </div>
                  <span class="prefilled-badge">{{
                    isEditMode ? "Fixo" : "Da Partida"
                  }}</span>
                </div>
              </div>
            </div>

            <!-- ===== CAMPO DE ROLE (SEMPRE EDIT√ÅVEL) ===== -->
            <div class="form-group role-field-group">
              <label for="role">
                ‚úèÔ∏è Fun√ß√£o
                <span *ngIf="shouldLockFields" class="editable-hint"
                  >(edit√°vel)</span
                >
              </label>
              <select id="role" formControlName="role" class="role-select">
                <option [ngValue]="null">N√£o informar</option>
                <option *ngFor="let role of roles" [value]="role">
                  {{ getRoleDisplayName(role) }}
                </option>
              </select>
              <small *ngIf="shouldLockFields" class="field-help">
                üí°
                {{
                  isEditMode
                    ? "A fun√ß√£o pode ser alterada mesmo durante a edi√ß√£o"
                    : "Voc√™ pode alterar a fun√ß√£o mesmo quando outros campos est√£o bloqueados"
                }}
              </small>
            </div>
          </div>
        </fieldset>
      </div>

      <div *ngIf="currentStep === 2">
        <fieldset class="form-section">
          <legend>3. Sua Avalia√ß√£o</legend>
          <div class="form-group rating-group">
            <label>Nota *</label>
            <div class="rating-input-container">
              <div
                *ngFor="let i of [1, 2, 3, 4, 5]"
                class="rating-input-square"
                (click)="setRating(i)"
                (mouseenter)="hoverRating = i"
                (mouseleave)="hoverRating = 0"
              >
                <div
                  class="rating-square-inner"
                  [ngClass]="{
                    filled:
                      (hoverRating || evaluationForm.get('rating')?.value) >= i,
                    half:
                      (hoverRating || evaluationForm.get('rating')?.value) ===
                      i - 0.5
                  }"
                >
                  <div
                    class="half-left"
                    (click)="setRating(i - 0.5, $event)"
                    (mouseenter)="hoverRating = i - 0.5"
                  ></div>
                  <div
                    class="half-right"
                    (click)="setRating(i, $event)"
                    (mouseenter)="hoverRating = i"
                  ></div>
                </div>
              </div>
            </div>
            <div
              *ngIf="
                evaluationForm.get('rating')?.invalid &&
                evaluationForm.get('rating')?.touched
              "
              class="error-message"
            >
              A nota √© obrigat√≥ria.
            </div>
          </div>

          <div class="form-group">
            <label for="tags">Tags (separadas por v√≠rgula)</label>
            <input
              id="tags"
              type="text"
              formControlName="tags"
              placeholder="Ex: comunicativo, bom farm, t√≥xico..."
            />
            <div
              class="tag-suggestions"
              *ngIf="suggestedTags$ | async as suggestions"
            >
              <span *ngIf="suggestions.length > 0">Sugest√µes:</span>
              <button
                type="button"
                *ngFor="let tag of suggestions"
                class="tag-suggestion-btn"
                (click)="addTag(tag)"
              >
                {{ tag }}
              </button>
            </div>
            <div
              *ngIf="evaluationForm.get('tags')?.errors as errors"
              class="error-message"
            >
              <span *ngIf="errors['maxTags']">M√°ximo de 5 tags permitido.</span>
              <span *ngIf="errors['maxTagLength']"
                >A tag '{{ errors["maxTagLength"].value }}' √© longa demais (m√°x
                25 caracteres).</span
              >
            </div>
          </div>

          <div class="form-group">
            <label for="notes">Anota√ß√µes</label>
            <textarea
              id="notes"
              rows="4"
              formControlName="notes"
              placeholder="Descreva o comportamento, pontos fortes e fracos..."
            ></textarea>
            <div
              class="char-counter"
              [class.error]="evaluationForm.get('notes')?.errors?.['maxlength']"
            >
              {{ evaluationForm.get("notes")?.value?.length || 0 }} / 200
            </div>
          </div>
        </fieldset>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="onClose()">
          Cancelar
        </button>
        <button
          type="button"
          class="btn-tertiary"
          *ngIf="currentStep === 2 && !isEditMode"
          (click)="prevStep()"
        >
          Voltar
        </button>
        <button
          type="button"
          class="btn-primary"
          *ngIf="currentStep === 1"
          (click)="nextStep()"
          [disabled]="
            evaluationForm.get('targetSteamId')?.invalid &&
            !evaluationForm.get('targetSteamId')?.disabled
          "
        >
          Pr√≥ximo
        </button>
        <button
          type="submit"
          class="btn-primary"
          *ngIf="currentStep === 2"
          [disabled]="evaluationForm.invalid"
        >
          {{ isEditMode ? "Salvar Altera√ß√µes" : "Criar Avalia√ß√£o" }}
        </button>
      </div>
    </form>
  </div>
</div>
